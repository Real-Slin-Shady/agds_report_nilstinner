---
title: "re_stepwise"
author: "Nils Tinner"
date: "`r Sys.Date()`"
output: html_document
---
# Setup and Loading
```{r, message=FALSE}
# Package names
packages <- c("lubridate","tidyverse","visdat","yardstick","purrr")

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}else{
  print("All packages sucessfully installed")
}

invisible(lapply(packages, library, character.only = TRUE))

hh_fluxes<- read_csv("../data/halfhourly_data.csv")

vis_miss(
  hh_fluxes,
  cluster = FALSE, 
  warn_large_data = FALSE
  )
```

# Evaluation of all Bivariate Models



```{r}
all_predictors <-
  hh_fluxes|>
  select(-siteid,
         -TIMESTAMP,
         -GPP_NT_VUT_REF)|>
  colnames()

models <-  list() #more elegant way?

for (predictor in all_predictors) {
  temp <- as.formula(paste("GPP_NT_VUT_REF~", paste(predictor, collapse="+")))
  models[[predictor]]<- lm(temp,data = hh_fluxes)
}

r_squared <- purrr::map(models,~summary(.)$r.squared)


predictor_rsquared <- r_squared[which.max(r_squared)]
modelACI <- extractAIC(models[[which.max(r_squared)]])[2]



#Add: Visualisation and Discussion

```




```{r}

all_predictors <-
  hh_fluxes|>
  select(-siteid,
         -TIMESTAMP,
         -GPP_NT_VUT_REF)|>
  colnames()
ACI_condition <- TRUE
old_modelACI <- Inf


while (ACI_condition) {
  
r_squared <- NULL #Is there a more elegant way?
models <-  list()

for (predictors in all_predictors) {
  temp <- as.formula(paste("GPP_NT_VUT_REF~", predictors))
  models[[predictors]]<- lm(temp,data = hh_fluxes)
}

r_squared <- purrr::map(models,~summary(.)$r.squared)

predictor_rsquared <- r_squared[which.max(r_squared)]

modelACI <- extractAIC(models[[which.max(r_squared)]])[2]



if (modelACI > old_modelACI) {
  ACI_condition <- FALSE
  print("Terminating since lower ACI with new predictors")
  
}

print("name:")
print(names(predictor_rsquared))
print("r-squared:")
print(predictor_rsquared[[1]])
print("ACI of these predictors: ")
print(modelACI)
cat("\n\n\n")
old_modelACI <- modelACI


all_predictors_separated <- strsplit(names(predictor_rsquared),split=' + ', fixed=TRUE)

all_predictors <-
  hh_fluxes|>
  select(-siteid,
         -TIMESTAMP,
         -GPP_NT_VUT_REF)|>
  colnames()

all_predictors <- all_predictors[!(all_predictors %in% all_predictors_separated[[1]])]

all_predictors <- paste(names(predictor_rsquared),all_predictors,sep = " + ")
}


```


# Evaluation of all Bivariate Models

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:





#Raw Function for 
```{r}
Stepwiseforward_tidy <- function(TidyDF,toPredict,removeColumns){
unused_predictors <-
  hh_fluxes|>
  select(-all_of(toPredict),
         -all_of(removeColumns))|>
  colnames()#Save unused predictors to a  vector, initallly all...

ACI_condition <- TRUE #Condition for loop
old_modelACI <- Inf #Initial state of ACI value...
Used_Predictors = NULL # Vector to later save the used predictor values
models = list()

while (ACI_condition) {
models_temp <-  list() #overriding to save models for each run

for (predictor in unused_predictors) {
  local_predictors <- unlist(c(Used_Predictors,predictor))#Somehow makes a list, needed as a vector so unlist
  local_predictors <- paste(local_predictors,collapse = " + ") #Now collapse vector
  formula_temp <- as.formula(paste(toPredict,"~", local_predictors)) #temporary formula
  models_temp[[local_predictors]]<- lm(formula_temp,data = hh_fluxes) #Save models to appripriate place
  #The name is used for later referral
}

r_squared <- purrr::map(models_temp,~summary(.)$r.squared) #Here summary for each model+name is created
predictor_rsquared <- r_squared[which.max(r_squared)] #Best one is chosen
#remove used predictors from pool:
Used_Predictors = strsplit(names(predictor_rsquared),split=' + ', fixed=TRUE) #separate the used predictors
unused_predictors <- unused_predictors[!(unused_predictors %in% Used_Predictors)] 
modelACI <- extractAIC(models_temp[[which.max(r_squared)]])[2]#Extraction of ACI

if (modelACI > old_modelACI) { #Checking for improved ACI value...
  ACI_condition <- FALSE
  print("Terminating since lower ACI with new predictors")
  
}else{
  old_modelACI <- modelACI #Replacing new one with old because check passed
  models[[names(predictor_rsquared)]] <- models_temp[[which.max(r_squared)]]}#Saving Model for later visualization

#UI-output
print("name:")
print(names(predictor_rsquared))
print("r-squared:")
print(predictor_rsquared[[1]])
print("ACI of these predictors: ")
print(modelACI)
cat("\n\n\n")
}
return(models)
}
models <- Stepwiseforward_tidy(hh_fluxes,"GPP_NT_VUT_REF",c("TIMESTAMP","siteid"))
```


#Visualisation
```{r}
  ggplot(models$`PPFD_IN + LW_IN_F + VPD_F + TA_F_MDS + SW_IN_F + P_F + WS_F + CO2_F_MDS + PA_F`,
         aes(.fitted, .resid))+geom_point()+
    stat_smooth(method="loess")+geom_hline(yintercept=0, col="red", linetype="dashed")+
    xlab("Fitted values")+ylab("Residuals")+
    ggtitle("Residual vs Fitted Plot")+theme_bw()
  ggplot(models$`PPFD_IN + LW_IN_F + VPD_F + TA_F_MDS + SW_IN_F + P_F + WS_F + CO2_F_MDS + PA_F`,
         aes(.hat, .stdresid))+geom_point(aes(size=.cooksd), na.rm=TRUE)+
    stat_smooth(method="loess", na.rm=TRUE)+
    xlab("Leverage")+ylab("Standardized Residuals")+
    ggtitle("Residual vs Leverage Plot")+
    scale_size_continuous("Cook's Distance", range=c(1,5))+
    theme_bw()+theme(legend.position="bottom")


R_squared <- purrr::map(models,~summary(.)$r.squared) |>
  unlist()|>
  as.data.frame()|>
  `colnames<-`("R")|>
  rownames_to_column(var = "rowname")


ggplot(data = R_squared ,aes(y = fct_rev(rowname), x = R)) +
  geom_col(fill = "grey70") +
  scale_x_continuous() +
  labs(y = "Predictors", x = "R-Squared")+
  theme_classic(base_size = 7)+
  geom_text(aes(label=fct_rev(rowname)),position = position_dodge(width = 1),hjust=1, size = 3)+
  theme(axis.text.y = element_blank())



ACI <- purrr::map(models,~extractAIC(.)[2]) |>
  unlist()|>
  as.data.frame()|>
  `colnames<-`("R")|>
  rownames_to_column(var = "rowname")


ggplot(data = ACI ,aes(y = fct_rev(rowname), x = R)) +
  geom_col(fill = "grey70") +
  scale_x_continuous() +
  labs(y = "Predictors", x = "ACI-Value")+
  theme_classic(base_size = 7)+
  geom_text(aes(label=fct_rev(rowname)),position = position_dodge(width = 1),hjust=1, size = 3)+
  theme(axis.text.y = element_blank())



  
```


